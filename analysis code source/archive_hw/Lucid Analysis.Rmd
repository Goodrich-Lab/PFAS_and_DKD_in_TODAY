---
title: 'TODAY LUCID analysis'
subtitle: ""
author: "Hongxu Wang"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{css, echo=FALSE}
pre {
max-height: 200px;
overflow-: auto;
}

```


```{r setup, include=FALSE, echo=FALSE}
options(knitr.table.format = "html")
knitr::opts_chunk$set(echo = TRUE)
source(here::here("!libraries.R"))
source(here::here("!directories.R"))
source(here::here("!load_clean_data.R"))
source(here::here("LUCIDusM in Parallel Sankey fxn Plotly.R"))
source(here::here("lucid_parallel.R"))
```

## Data Summary
```{r summary, cache.comments=FALSE, warning=FALSE, message=FALSE}
exposure_name <- c("met_homovanillic_acid", "met_histidine", "met_hydroxyphenyllactic_acid")

pfas_c <- c("pfas_pfda", "pfas_pfhpa", "pfas_pfna", "pfas_pfuna", "pfas_pfoa")
pfas_s <- c("pfas_pfhps", "pfas_pfhxs", "pfas_pfos")

outcome <- c("mic", "daystomic", "daystomac", "rapid", "daystorapid","daystohyp")

table1::table1(~factor(mic) + factor(rapid), full_data %>% select(exposure_name, pfas_c, pfas_s, outcome))

table1::table1(~., full_data %>% select(exposure_name, pfas_c, pfas_s, outcome[c(2,3,5)]))
```

## Lucid Analysis
* Exposure: met_homovanillic_acid,met_histidine,met_hydroxyphenyllactic_acid
* Latent clusters: 
  + Carboxylic acids: pfas_pfda, pfas_pfhpa, pfas_pfna, pfas_pfuna, pfas_pfoa
  + Sulfonic Acids: pfas_pfhps, pfas_pfhxs, pfas_pfos 
* Outcome: mic, daystomic, daystomac, rapid, daystorapid,daystohyp
* Note: met_homovanillic_acid was not included in the analysis since unique value

```{r lucid in parallel,cache.comments=FALSE, warning=FALSE, message=FALSE,results='hide'}
G = full_data %>% select(exposure_name[-1]) %>% as.matrix() %>% scale()

Z =  list(Carboxylic = full_data %>%
            select(sample_id, all_of(pfas_c)) %>%
            column_to_rownames("sample_id") %>%
            as.matrix() |> scale() ,
          Sulfonic = full_data %>%
            select(sample_id, all_of(pfas_s)) %>%
            column_to_rownames("sample_id") %>%
            as.matrix() |> scale() )

Y = full_data %>% 
  dplyr::select(all_of(outcome)) %>%
  mutate_at(.vars = c(outcome),
            .funs = ~unlist(.) %>% as.numeric()) %>%
  mutate_at(.vars = c(outcome[c(2,3,5,6)]),
            .funs = ~scale(.))
  

df <- data.frame()
plot <- vector("list", length(length(outcome)))

for (i in c(2,3,5,6)){
  fit <- LUCIDusM::est_lucid(
    G = G, 
    Z = Z,
    Y = Y[,i],
    K = rep(2, length(Z)),
    family = "gaussian",
    max_itr = 200,
    useY = TRUE,
    modelNames = rep("EEV", length(Z)))
    fit_reordered <- reorder_lucidM(fit, reference = c(1,2))
    # fit_reordered <- fit
    est <- data.frame(
                     outcome = colnames(Y)[i],
                     Exposure1_to_Carboxylic =
                       fit_reordered$res_Beta$Beta[[1]][,2],
                     Exposure1_to_Sulfonic = 
                       fit_reordered$res_Beta$Beta[[2]][,2], 
                     Exposure2_to_Carboxylic =
                       fit_reordered$res_Beta$Beta[[1]][,3],
                     Exposure2_to_Sulfonic = 
                       fit_reordered$res_Beta$Beta[[2]][,3],
                     # Exposure3_to_Carboxylic =
                     #   fit_reordered$res_Beta$Beta[[1]][,4],
                     # Exposure3_to_Sulfonic = 
                     #   fit_reordered$res_Beta$Beta[[2]][,4],
                     Carboxylic_to_outcome =
                       fit_reordered$res_Delta$fit$coefficient[2],
                     Sulfonic_to_outcome = 
                       fit_reordered$res_Delta$fit$coefficient[3])
    df <- df %>% bind_rows(est)
    (plot[[i]] <- plot_lucid_in_parallel_plotly(fit_reordered,
                                      sankey_colors =
                                        sankey_colors,
                                      text_size = 12))
    names(plot)[i] <- paste0(colnames(Y)[i])
    htmlwidgets::saveWidget(plot[[i]], file = fs::path(dir_figure,str_c("lucid_in_parallel_", colnames(Y)[i],".html")))
}

for (i in c(1)){
  fit <- LUCIDusM::est_lucid(
    G = G, 
    Z = Z,
    Y = Y[,i],
    K = rep(2, length(Z)),
    family = "binomial",
    max_itr = 200,
    useY = TRUE,
    modelNames = rep("EEV", length(Z)))
    fit_reordered <- reorder_lucidM(fit, reference = c(1,1))
    # fit_reordered <- fit
    est <- data.frame(
                     outcome = colnames(Y)[i],
                     Exposure1_to_Carboxylic =
                       fit_reordered$res_Beta$Beta[[1]][,2],
                     Exposure1_to_Sulfonic = 
                       fit_reordered$res_Beta$Beta[[2]][,2], 
                     Exposure2_to_Carboxylic =
                       fit_reordered$res_Beta$Beta[[1]][,3],
                     Exposure2_to_Sulfonic = 
                       fit_reordered$res_Beta$Beta[[2]][,3],
                     # Exposure3_to_Carboxylic =
                     #   fit_reordered$res_Beta$Beta[[1]][,4],
                     # Exposure3_to_Sulfonic = 
                     #   fit_reordered$res_Beta$Beta[[2]][,4],
                     Carboxylic_to_outcome =
                       fit_reordered$res_Delta$fit$coefficient[2],
                     Sulfonic_to_outcome = 
                       fit_reordered$res_Delta$fit$coefficient[3])
    df <- df %>% bind_rows(est)
    (plot[[i]] <- plot_lucid_in_parallel_plotly(fit_reordered,
                                      sankey_colors =
                                        sankey_colors,
                                      text_size = 12))
    names(plot)[i] <- paste0(colnames(Y)[i])
    htmlwidgets::saveWidget(plot[[i]], file = fs::path(dir_figure,str_c("lucid_in_parallel_", colnames(Y)[i],".html")))
}

for (i in c(4)){
  fit <- LUCIDusM::est_lucid(
    G = G, 
    Z = Z,
    Y = Y[,i],
    K = rep(2, length(Z)),
    family = "binomial",
    max_itr = 200,
    useY = TRUE,
    modelNames = rep("EEV", length(Z)))
    fit_reordered <- reorder_lucidM(fit, reference = c(2,2))
    # fit_reordered <- fit
    est <- data.frame(
                     outcome = colnames(Y)[i],
                     Exposure1_to_Carboxylic =
                       fit_reordered$res_Beta$Beta[[1]][,2],
                     Exposure1_to_Sulfonic = 
                       fit_reordered$res_Beta$Beta[[2]][,2], 
                     Exposure2_to_Carboxylic =
                       fit_reordered$res_Beta$Beta[[1]][,3],
                     Exposure2_to_Sulfonic = 
                       fit_reordered$res_Beta$Beta[[2]][,3],
                     # Exposure3_to_Carboxylic =
                     #   fit_reordered$res_Beta$Beta[[1]][,4],
                     # Exposure3_to_Sulfonic = 
                     #   fit_reordered$res_Beta$Beta[[2]][,4],
                     Carboxylic_to_outcome =
                       fit_reordered$res_Delta$fit$coefficient[2],
                     Sulfonic_to_outcome = 
                       fit_reordered$res_Delta$fit$coefficient[3])
    df <- df %>% bind_rows(est)
    (plot[[i]] <- plot_lucid_in_parallel_plotly(fit_reordered,
                                      sankey_colors =
                                        sankey_colors,
                                      text_size = 12))
    names(plot)[i] <- paste0(colnames(Y)[i])
    htmlwidgets::saveWidget(plot[[i]], file = fs::path(dir_figure,str_c("lucid_in_parallel_", colnames(Y)[i],".html")))
}

writexl::write_xlsx(df, fs::path(dir_results, "LUCID/lucid_in_parellel_est.xlsx"))
```

## Outcome: mic
```{r plot mic}
plot[[1]]
```

## Outcome: daystomic
```{r plot daystomic}
plot[[2]]
```

## Outcome: daystomac
```{r daystomac}
plot[[3]]
```

## Outcome: rapid
```{r rapid}
plot[[4]]
```

## Outcome: daystorapid
```{r daystorapid}
plot[[5]]
```

## Outcome: daystohyp
```{r daystophy}
plot[[6]]
```

## Outcome: Rapid. Exposure: 4 metabolites

```{r rapid with 4met,cache.comments=FALSE, warning=FALSE, message=FALSE, results='hide'}
G = full_data %>% select(exposure_name[-1], "met_glycine", "met_2_methyl_3_hydroxybutyric_acid") %>% as.matrix() %>% scale()

fit <- LUCIDusM::est_lucid(
    G = G, 
    Z = Z,
    Y = Y[,4],
    K = rep(2, length(Z)),
    family = "gaussian",
    max_itr = 200,
    useY = TRUE,
    modelNames = rep("EEV", length(Z)))

fit_reordered <- reorder_lucidM(fit, reference = c(2,2))

p <- plot_lucid_in_parallel_plotly(fit_reordered,
                                      sankey_colors =
                                        sankey_colors,
                                      text_size = 12)

htmlwidgets::saveWidget(p, file = fs::path(dir_figure,"lucid_in_parallel_rapid_with_4met.html"))
```

```{r plot}
p
```

