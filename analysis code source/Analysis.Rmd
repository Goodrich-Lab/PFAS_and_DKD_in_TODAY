---
title: 'Today project'
author: "Hongxu Wang"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  html_document:
    toc: true
    toc_float: true
    df_print: paged
    code_folding: hide
editor_options: 
  chunk_output_type: console
---
<style type="text/css">
  body{
  font-size: 12pt;
}
</style>

```{r exposure outcome setup, include=FALSE}
source(here::here("!libraries.R"))
source(here::here("!directories.R"))
source(here::here("!load_clean_data.R"))
source(here::here("analysis function_Multiple exposures and multiple outcomes analysis.R"))

options(knitr.table.format = "html")
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r define variables}
outcome_glu <- c("codi", 
             "si_1_ins0",
             "hb_a1c" 
             )

outcome_biomaker <- c("seq.2836.68",
                      "seq.9021.1",
                      "seq.5661.15",
                      "seq.11516.7",
                      "seq.17138.8",
                      "seq.12446.49",
                      "seq.15509.2")

pfas_names_all <- c("pfas_pfos", 
                    "pfas_pfoa", 
                    "pfas_pfhxs", 
                    "pfas_pfna", 
                    "pfas_pfda", 
                    "pfas_nmefosaa", 
                    "pfas_pfhps", 
                    "pfas_pfhpa", 
                    "pfas_pfuna")

covars <- c("case1_control0", 
            "sex", 
            "agebase", 
            "dxtime",
            "tx",
            # kidney functions
            "est_creat_clear",
            "uacid",
            "u_alb_creat",
            "serum_creat")

levels <- c("PFUnA", "PFHpS","PFHpA","NMeFOSAA","PFDA","PFNA","PFHxS", "PFOA", "PFOS"
)
```


## Analysis with whole group adjusted for "case1_control0", "sex", "agebase", "tx", "dxtime"
```{r whole group}
data <- full_data %>% 
  mutate_at(.vars = vars(all_of(pfas_names)),
            .funs = ~log2(.) %>% scale(.) %>% as.numeric(.))%>%
  mutate_at(.vars = vars(outcome[c(1:4, 6,7,9, 11)]),
            .funs = ~scale(.) %>% as.numeric(.))

cont_outcome_result <- model_output(pfas_names,
                                    outcomes = outcome[c(1:4, 6,7,9,11)],
                                    covars = covars[1:5] ,
                                    outcome_family = "gaussian",
                                    data = data) %>%
  mutate(sig = ifelse(p.value < 0.05, "Sig.", "Not Sig."))

cont_result <- cont_outcome_result %>% 
  filter(term == "exposure_concentration") %>%
  select(-term) %>%
  filter(!exposures %in% 
           c("pfas_br_pfos", "pfas_l_pfoa", "pfas_l_pfos")) %>%
  mutate(pfas_name = case_when(grepl("pfos", exposures) ~ "PFOS",
                               grepl("pfoa", exposures) ~ "PFOA",
                               grepl("pfda", exposures) ~ "PFDA",
                               grepl("pfhpa", exposures) ~ "PFHpA",
                               grepl("pfhps", exposures) ~ "PFHpS",
                               grepl("pfhxs", exposures) ~ "PFHxS",
                               grepl("pfna", exposures) ~ "PFNA",
                               grepl("pfuna", exposures) ~ "PFUnA",
                               grepl("nmefosaa", exposures) ~ "NMeFOSAA"))

cat_outcome_result <- model_output(pfas_names,
                                   outcomes = outcome[c(5, 8, 10)],
                                   covars = covars[1:5],
                                   outcome_family = "binomial",
                                   data = data)

cat_result <- cat_outcome_result %>% 
  filter(term == "exposure_concentration") %>%
  select(-term) %>%
  filter(!exposures %in% 
           c("pfas_br_pfos", "pfas_l_pfoa", "pfas_l_pfos")) %>%
  mutate(pfas_name = case_when(grepl("pfos", exposures) ~ "PFOS",
                               grepl("pfoa", exposures) ~ "PFOA",
                               grepl("pfda", exposures) ~ "PFDA",
                               grepl("pfhpa", exposures) ~ "PFHpA",
                               grepl("pfhps", exposures) ~ "PFHpS",
                               grepl("pfhxs", exposures) ~ "PFHxS",
                               grepl("pfna", exposures) ~ "PFNA",
                               grepl("pfuna", exposures) ~ "PFUnA",
                               grepl("nmefosaa", exposures) ~ "NMeFOSAA")) %>%
  mutate(sig = ifelse(p.value < 0.05, "Sig.", "Not Sig."))


## coefficient plot
(p1 <- cont_result %>%
  ggplot(aes(x = factor(pfas_name, levels = levels),y = estimate, color = sig)) +
  geom_point(size = 1) +
  geom_errorbar(aes(ymin = conf.low,
                    ymax = conf.high),
                width = 0) +
  geom_hline(yintercept = 0, linetype = 2) +
  facet_grid( ~ outcome, scales = "free") +
  ylab("Coefficient (95% CI)") +
  # ggtitle("Coefficient Plot (Binary Logistic Regression)") +
  theme(text = element_text(size = 10),
        axis.title.y = element_blank(),
        panel.background = element_rect(fill="white"), 
        strip.background = element_rect(fill = "white"),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        legend.position = "none") +
  coord_flip() +
  scale_color_manual(values = c("grey", "red")))

ggsave(fs::path(dir_figure, 
                "1127_hw",
                "coef_plot_cont_outcome_full_group.png"), bg = "white",
       width = 8, height = 3, dpi = 300)

(p2 <- cat_result %>%
  ggplot(aes(x = factor(pfas_name, levels = levels),y = exp(estimate), color = sig)) +
  geom_point(size = 1) +
  coord_flip() +
  geom_errorbar(aes(ymin = exp(conf.low),
                    ymax = exp(conf.high)),
                width = 0) +
  geom_hline(yintercept = 1, linetype = 2) +
  facet_grid( ~ outcome, scales = "free") +
  ylab("Odds Ratio (95% CI)") +
  theme(text = element_text(size = 10),
        axis.title.y = element_blank(),
        panel.background = element_rect(fill="white"), 
        strip.background = element_rect(fill = "white"),
        axis.line.x = element_line(color = "black"),
        axis.line.y = element_line(color = "black"),
        legend.position = "none") +
  coord_flip() +
  scale_color_manual(values = c("grey", "red")))

ggsave(fs::path(dir_figure, 
                "1127_hw",
                "coef_plot_cat_outcome_full_group.png"), bg = "white",
       width =  8, height = 3, dpi = 300)
```

## Mixture analysis - qgcomp
**Categorical outcomes were not included here.
```{r mixture analysis}
rename_outcomes <- function(x){
  nms <- case_when(
    x=="time_to_glyc_scld" ~ "Time to glycemic failure", 
    x=="codi" ~ "β-cell function (C-Peptide oDI)",
    x=="si_1_ins0" ~  "Ins. Sensitivity (1/fast. ins)",
    x=="hb_a1c" ~ "Hyperglycemia (HbA1c)", 
    x=="daystomic" ~ "Time to microalbuminuria", 
    x== "daystorapid" ~ "Time to rapid",
    x== "daystohyp" ~ "Time to hyperfiltration",
    x=="est_creat_clear" ~ "Estimated Creatinine Clearance",
    x=="daystomac" ~ "Time to macroalbuminuria",
    x=="uacid" ~ "Uric Acid",
    x=="u_alb_creat" ~ "u_alb_creat",
    x=="serum_creat" ~ "Serum Creatanine")
}

# qgcomp --------
(qgcomp <- owas_qgcomp(df = data, 
                           expnms = pfas_names_all, 
                           omics = outcome[c(1:4, 6:7, 9,11)], 
                           covars = covars[1:4],
                           confidence_level = 0.90,
                           q = 3) |>
  mutate(type = "covars with no kidney functions") %>%
  select(feature, psi, lcl_psi, ucl_psi, p_value, type))


(qgcomp_kidney1 <- owas_qgcomp(df = data, 
                           expnms = pfas_names_all, 
                           omics = outcome[c(6:7, 9, 11)], 
                           covars = covars[c(1:4, 6)],
                           confidence_level = 0.90,
                           q = 3) |>
  mutate(type = "Estimated Creatinine Clearance") %>%
  select(feature, psi, lcl_psi, ucl_psi,p_value, type))

(qgcomp_kidney2 <- owas_qgcomp(df = data, 
                           expnms = pfas_names_all, 
                           omics = outcome[c(6:7, 9, 11)], 
                           covars = covars[c(1:4, 7)],
                           confidence_level = 0.90,
                           q = 3) |>
  mutate(type = "Uric Acid") %>%
  select(feature, psi,lcl_psi, ucl_psi, p_value, type))

(qgcomp_kidney3 <- owas_qgcomp(df = data, 
                           expnms = pfas_names_all, 
                           omics = outcome[c(6:7, 9, 11)], 
                           covars = covars[c(1:4, 8)],
                           confidence_level = 0.90,
                           q = 3) |>
  mutate(type = "u_alb_creat") %>%
  select(feature, psi, lcl_psi, ucl_psi,p_value, type))

(qgcomp_kidney4 <- owas_qgcomp(df = data, 
                           expnms = pfas_names_all, 
                           omics = outcome[c(6:7, 9, 11)], 
                           covars = covars[c(1:4, 9)],
                           confidence_level = 0.90,
                           q = 3) |>
  mutate(type = "Serum Creatanine") %>%
  select(feature, psi,lcl_psi, ucl_psi, p_value, type))

# Combine results
(qgcomp_res <- bind_rows(qgcomp, qgcomp_kidney1, 
                        qgcomp_kidney2, qgcomp_kidney3,
                        qgcomp_kidney4) |>
  mutate(feature_names=rename_outcomes(feature)))

reorder_outcome_name <- c("Hyperglycemia (HbA1c)", 
                          "β-cell function (C-Peptide oDI)",  
                          "Ins. Sensitivity (1/fast. ins)",
                          "Time to glycemic failure", 
                          # "Time to microalbuminuria", 
                          "Estimated Creatinine Clearance",
                          "Time to macroalbuminuria") 
# Get color scale
colors <- RColorBrewer::brewer.pal(n=3, name = "Dark2")[1:2]

# Reorder outcome name and set color scale
qgcomp_res_fin <- qgcomp_res |>
  filter(type == "covars with no kidney functions") %>%
  mutate(feature_names = fct_relevel(feature_names, 
                                     reorder_outcome_name) |> 
           fct_rev()) |>
  arrange(feature_names)

# Plot all outcomes 
(plotout <- qgcomp_res_fin |>
    ggplot(aes(y = psi, 
               x = feature_names)) +
    geom_point(size = 3) +
    geom_errorbar(aes(ymin = lcl_psi,
                      ymax = ucl_psi),
                  width = 0, size = .75) +
    geom_hline(yintercept = 0, linetype = 2, linewidth = .5) +
    theme(axis.title.y = element_blank(), 
          axis.text.y = element_text(size = 14, vjust = .5)) +
    # scale_color_manual(values = colors) + 
    ylab("PFAS Mixture") + 
    coord_flip() + 
    theme(legend.position = "None"))


ggsave(plotout,
       filename = fs::path(dir_figure, 
                           "QGComp pfas mixture TODAY_1129.jpeg"),
       height = 2.25, width = 5, bg = "white")
```

## Survival analysis
```{r survival analysis}

pfas_min <-  c("pfas_pfna", "pfas_pfda", "pfas_pfhpa", 'pfas_pfoa', 
               "pfas_pfos", "pfas_pfhps", "pfas_pfhxs")

data <- data |> 
  tidylog::select(-all_of(prot_names), -contains("met_")) |>
  fastDummies::dummy_cols(select_columns = c('tx', 'sex'),
                          remove_selected_columns = TRUE, 
                          remove_most_frequent_dummy = TRUE) |>
  mutate(yrstohyp = (daystohyp)/365, 
         yrstohyp2 = yrstohyp + dxtime/12, 
         yrstomic = (daystomic)/365, 
         yrstomic2 = (yrstomic+dxtime/12),
         yrstomac = (daystomac)/365,
         yrstomac2 = (yrstomac+dxtime/12),
         mac2 = if_else(yrstomac > 8.5, 0, 1),
         mic2 = if_else(yrstomic > 8.5, 0, 1), 
         hyp2 = if_else(yrstohyp > 8.5, 0, 1))
```

### glyc 
**basic covars: case1_control0, agebase, sex**
* no kidney function covar
```{r glyc}
(qc.survfit <- qgcomp::qgcomp.cox.noboot(
  survival::Surv(time_to_glyc_scld, glyc) ~ ., 
  expnms = pfas_min,
  data = data |> 
    select(all_of(pfas_min), 
           # covars[c(1,3)],
           sex_male,
           time_to_glyc_scld, 
           glyc),
  q = 2))
```

### hyperperfusion 
**basic covars: case1_control0, agebase, sex**
* no kidney function covar
```{r hyperperfusion}
(qc.survfit <- qgcomp::qgcomp.cox.noboot(
  survival::Surv(yrstohyp2, hyp) ~ ., 
  expnms = pfas_min,
  data = data |> 
    select(all_of(pfas_min), 
           # covars[c(1,3,4,6)],
           # sex_male,
           covars[c(1,3)],
           sex_male,
           yrstohyp2, 
           hyp),
  q = 2))
```

* covar: kidney function - est_creat_clear
```{r hyper-est_creat_clear}
(qc.survfit <- qgcomp::qgcomp.cox.noboot(
  survival::Surv(yrstohyp2, hyp) ~ ., 
  expnms = pfas_min,
  data = data |> 
    select(all_of(pfas_min), 
           # covars[c(1,3,4,6)],
           # sex_male,
           covars[c(1,3,6)],
           sex_male,
           yrstohyp2, 
           hyp),
  q = 2))
```

* covar: kidney function - uacid
```{r hyper-uacid}
(qc.survfit <- qgcomp::qgcomp.cox.noboot(
  survival::Surv(yrstohyp2, hyp) ~ ., 
  expnms = pfas_min,
  data = data |> 
    select(all_of(pfas_min), 
           # covars[c(1,3,4,6)],
           # sex_male,
           covars[c(1,3,7)],
           sex_male,
           yrstohyp2, 
           hyp),
  q = 2))
```

* covar: kidney function - u_alb_creat
```{r hyper-u_alb_creat}
(qc.survfit <- qgcomp::qgcomp.cox.noboot(
  survival::Surv(yrstohyp2, hyp) ~ ., 
  expnms = pfas_min,
  data = data |> 
    select(all_of(pfas_min), 
           # covars[c(1,3,4,6)],
           # sex_male,
           covars[c(1,3,8)],
           sex_male,
           yrstohyp2, 
           hyp),
  q = 2))
```

* covar: kidney function - serum_creat
```{r hyper-serum_creat}
(qc.survfit <- qgcomp::qgcomp.cox.noboot(
  survival::Surv(yrstohyp2, hyp) ~ ., 
  expnms = pfas_min,
  data = data |> 
    select(all_of(pfas_min), 
           # covars[c(1,3,4,6)],
           # sex_male,
           covars[c(1,3,9)],
           sex_male,
           yrstohyp2, 
           hyp),
  q = 2))
```


### microalbuminuria
**basic covars: case1_control0, agebase, sex**

* no kidney function covariates
```{r microalbuminuria}
(qc.survfit <- qgcomp::qgcomp.cox.noboot(
  survival::Surv(yrstomic2, mic) ~ ., 
  expnms = pfas_min,
  data = data |> 
    select(all_of(pfas_min), 
           # covars[c(1,3,4,6)],
           # sex_male,
           covars[c(1,3)],
           sex_male,
           yrstomic2, 
           mic),
  q = 2))
```

* covar: kidney function - est_creat_clear
```{r microalbuminuria-est_creat_clear}
(qc.survfit <- qgcomp::qgcomp.cox.noboot(
  survival::Surv(yrstomic2, mic) ~ ., 
  expnms = pfas_min,
  data = data |> 
    select(all_of(pfas_min), 
           # covars[c(1,3,4,6)],
           # sex_male,
           covars[c(1,3,6)],
           sex_male,
           yrstomic2, 
           mic),
  q = 2))
```

* covar: kidney function - uacid
```{r microalbuminuria-uacid}
(qc.survfit <- qgcomp::qgcomp.cox.noboot(
  survival::Surv(yrstomic2, mic) ~ .,  
  expnms = pfas_min,
  data = data |> 
    select(all_of(pfas_min), 
           # covars[c(1,3,4,6)],
           # sex_male,
           covars[c(1,3,7)],
           sex_male,
           yrstomic2, 
           mic),
  q = 2))
```

* covar: kidney function - u_alb_creat
```{r microalbuminuria-u_alb_creat}
(qc.survfit <- qgcomp::qgcomp.cox.noboot(
  survival::Surv(yrstomic2, mic) ~ .,  
  expnms = pfas_min,
  data = data |> 
    select(all_of(pfas_min), 
           # covars[c(1,3,4,6)],
           # sex_male,
           covars[c(1,3,8)],
           sex_male,
           yrstomic2, 
           mic),
  q = 2))
```

* covar: kidney function - serum_creat
```{r microalbuminuria-serum_creat}
(qc.survfit <- qgcomp::qgcomp.cox.noboot(
  survival::Surv(yrstomic2, mic) ~ .,  
  expnms = pfas_min,
  data = data |> 
    select(all_of(pfas_min), 
           # covars[c(1,3,4,6)],
           # sex_male,
           covars[c(1,3,9)],
           sex_male,
           yrstomic2, 
           mic),
  q = 2))
```

## Survival Analysis
**Significant result were found between mixture and hyp with u_alb_creat in the model**
```{r bootstrap}
set.seed(111)
qc.survfit2 <- qgcomp::qgcomp.cox.boot(
  survival::Surv(yrstohyp2, hyp) ~ ., 
  expnms = pfas_min,
  data = data |>
    select(all_of(pfas_min), 
           # covars[c(1,3,8)],
           covars[c(1,8)],
           # sex_male,
           yrstohyp2, 
           hyp),
  q = 2, B=5*32, MCsize=20000, parallel=TRUE, parplan=TRUE)

qc.survfit2
plot(qc.survfit2)
# qc.survfit2 # with male as covar
# p <- plot(qc.survfit2, suppressprint = TRUE) 
p <- plot(qc.survfit2, suppressprint = TRUE, linewidth = 10) 
(out <- p + scale_color_manual(values = c("00FFFF", "black")) + 
    scale_linetype_manual(values = c(0,1,1)) + 
    geom_hline(yintercept = 0.5) + 
    labs(y = "DKD Free (%)") +
    theme(legend.position = "none"))

# Save plot
ggsave(out, 
       filename = fs::path(dir_results, "Jesse_K01_KM_curve_PFAS_dkd.jpeg"), 
       width = 1.5, 
       height = 1.5, dpi = 600)
```

